# Production Branch Workflow

Quick reference for the production branch deployment strategy.

## Branch Strategy

- **`main`**: Development branch - all active development happens here
- **`production`**: Production branch - triggers deployment to GitHub Pages
- **`gh-pages`**: Auto-generated by GitHub Actions (don't modify manually)

## Initial Setup

### 1. Create Production Branch

**Option A: Using setup script (recommended)**
```bash
# Windows (PowerShell)
.\setup-production-branch.ps1

# macOS/Linux
chmod +x setup-production-branch.sh
./setup-production-branch.sh
```

**Option B: Manual setup**
```bash
# Create production branch from main
git checkout main
git pull origin main
git checkout -b production
git push -u origin production
```

### 2. Enable GitHub Pages

1. Go to repository **Settings** ‚Üí **Pages**
2. Source: `gh-pages` branch, `/` (root)
3. Click **Save**

### 3. Configure WebSocket Server URL

1. **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions** ‚Üí **Variables**
2. **New repository variable**:
   - Name: `WS_SERVER_URL`
   - Value: `wss://your-production-server.com`

### 4. (Optional) Protect Production Branch

1. **Settings** ‚Üí **Branches** ‚Üí **Add rule**
2. Branch name pattern: `production`
3. Enable:
   - ‚úÖ Require pull request reviews before merging
   - ‚úÖ Require status checks to pass
   - ‚úÖ Require branches to be up to date before merging
   - ‚úÖ Include administrators (recommended)

---

## Daily Workflow

### Development (on `main` branch)

```bash
# Switch to main
git checkout main

# Pull latest changes
git pull origin main

# Create feature branch (optional but recommended)
git checkout -b feature/my-feature

# Make changes
# ... edit code ...

# Commit changes
git add .
git commit -m "Add new feature"

# Push to main (or create PR if using feature branches)
git push origin feature/my-feature  # If using feature branch
# OR
git push origin main  # Direct push to main
```

**Note:** Pushing to `main` does **NOT** trigger deployment. It's safe to push frequently.

### Deploy to Production

When ready to deploy changes to production:

```bash
# Ensure main is up to date
git checkout main
git pull origin main

# Switch to production
git checkout production

# Pull latest production state
git pull origin production

# Merge main into production
git merge main

# If there are conflicts, resolve them, then:
# git add .
# git commit -m "Merge main into production"

# Push to production (triggers deployment)
git push origin production
```

**This triggers the GitHub Actions workflow and deploys to GitHub Pages.**

### Fast-track Deploy (if main is clean)

```bash
# Quick one-liner to deploy
git checkout production && git pull && git merge main && git push origin production && git checkout main
```

---

## Hotfix Workflow

For urgent fixes that need to go directly to production:

```bash
# Create hotfix branch from production
git checkout production
git pull origin production
git checkout -b hotfix/critical-fix

# Make the fix
# ... edit code ...

# Commit the fix
git add .
git commit -m "Fix critical bug"

# Merge into production
git checkout production
git merge hotfix/critical-fix
git push origin production  # Deploys immediately

# Merge back into main to keep in sync
git checkout main
git merge hotfix/critical-fix
git push origin main

# Clean up
git branch -d hotfix/critical-fix
```

---

## Rollback to Previous Version

If a deployment breaks something:

### Option 1: Revert the Merge

```bash
git checkout production
git pull origin production

# Find the problematic commit
git log --oneline

# Revert it
git revert <commit-hash>
git push origin production  # Triggers re-deployment
```

### Option 2: Reset to Previous State

```bash
git checkout production
git pull origin production

# Reset to previous commit (CAUTION: This rewrites history)
git reset --hard HEAD~1

# Force push (requires force push permissions)
git push --force origin production  # Triggers re-deployment
```

**Note:** Force push is dangerous and should be used carefully.

---

## Monitoring Deployments

### Check Deployment Status

1. Go to **Actions** tab in GitHub
2. Look for "Deploy to GitHub Pages" workflow
3. Green checkmark = successful
4. Red X = failed (click to see logs)

### View Live Site

After successful deployment (takes 2-5 minutes):
```
https://<username>.github.io/tsurust/
```

Example: `https://gallowstree.github.io/tsurust/`

---

## Common Scenarios

### Scenario 1: Multiple features ready to deploy

```bash
# All features are merged into main
git checkout production
git pull
git merge main
git push origin production  # Deploys all features at once
```

### Scenario 2: Deploy only specific features

```bash
# Cherry-pick specific commits from main
git checkout production
git cherry-pick <commit-hash-1>
git cherry-pick <commit-hash-2>
git push origin production
```

### Scenario 3: Test before deploying

```bash
# Create a staging branch (optional)
git checkout -b staging
git merge main

# Manual deployment test
# Actions ‚Üí Run workflow ‚Üí Select 'staging' branch

# If tests pass, deploy to production
git checkout production
git merge staging
git push origin production
```

---

## Branch Synchronization

Keep `main` and `production` in sync:

### Check for differences

```bash
# See what's in main but not in production
git log production..main --oneline

# See what's in production but not in main (shouldn't be anything)
git log main..production --oneline
```

### Keep production up to date

```bash
# Regularly merge main into production
git checkout production
git merge main
git push origin production
```

---

## Troubleshooting

### Production is ahead of main (unexpected)

This happens if hotfixes were made directly on production:

```bash
# Sync main with production
git checkout main
git merge production
git push origin main
```

### Deployment workflow doesn't trigger

**Check:**
1. Workflow file exists: `.github/workflows/deploy-pages.yml`
2. Branch name is exactly `production` (case-sensitive)
3. Changes are in watched paths (`client-egui/**`, `common/**`)
4. Workflow permissions are enabled (Settings ‚Üí Actions ‚Üí General)

**Manually trigger:**
1. Go to **Actions** ‚Üí **Deploy to GitHub Pages**
2. Click **Run workflow**
3. Select `production` branch
4. Click **Run workflow**

### Merge conflicts

When merging main into production:

```bash
git checkout production
git merge main

# If conflicts occur:
# 1. Resolve conflicts in your editor
# 2. Mark as resolved:
git add .
git commit -m "Merge main into production (resolve conflicts)"
git push origin production
```

---

## Quick Reference

| Action | Command |
|--------|---------|
| **Start developing** | `git checkout main` |
| **Deploy to prod** | `git checkout production && git merge main && git push` |
| **Check deployment** | GitHub ‚Üí Actions tab |
| **View live site** | `https://<username>.github.io/tsurust/` |
| **Rollback** | `git revert <commit>` or `git reset --hard` |
| **Manual deploy** | Actions ‚Üí Run workflow ‚Üí production branch |

---

## Best Practices

1. ‚úÖ **Always develop on `main`** - never commit directly to `production`
2. ‚úÖ **Test on `main` first** - ensure features work before deploying
3. ‚úÖ **Use feature branches** - for better organization and code review
4. ‚úÖ **Document deployments** - use descriptive merge commit messages
5. ‚úÖ **Monitor after deployment** - check Actions tab and live site
6. ‚úÖ **Keep branches synced** - regularly merge main into production
7. ‚úÖ **Protect production** - enable branch protection rules
8. ‚ùå **Don't force push to production** - unless absolutely necessary
9. ‚ùå **Don't skip testing** - always test features on main before deploying

---

## Emergency Contacts

If something breaks in production:

1. **Check Actions logs** for build errors
2. **Rollback immediately** using revert or reset
3. **Fix the issue on main**
4. **Deploy the fix** when ready

Remember: The production branch is your **live site**. Treat it with care! üöÄ
